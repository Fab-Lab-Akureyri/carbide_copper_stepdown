<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Code Multi-pass Generator</title>
</head>

<body>
    <h2>G-Code Multi-pass Generator</h2>
    <input type="file" id="fileInput" accept=".txt,.nc,.gcode">
    <br><br>
    <button onclick="generateMultiPass()">Generate Multi-pass G-code</button>
    <br><br>
    <a id="downloadLink" style="display: none;">Download Processed G-code</a>

    <script>
        async function generateMultiPass() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a G-code file.');
                return;
            }
            const fileText = await file.text();

            const inputGcode = fileText.split('\n');
            let outputGcode = '';
            let zDepth;

            // Find the initial Z-depth
            for (let line of inputGcode) {
                if (line.includes("G01") && line.includes("Z")) {
                    const zValue = line.split("Z")[1].trim();
                    if (!isNaN(zValue) && zValue < 0) {
                        zDepth = parseFloat(zValue);
                        break;
                    }
                }
            }

            if (!zDepth) {
                alert("Z-depth not found in the input G-code.");
                return;
            }

            const increments = [zDepth / 3, (2 * zDepth) / 3, zDepth];

            // Write initial header
            for (let line of inputGcode) {
                if (line.startsWith("G00") || line.startsWith("G01")) {
                    break;
                }
                outputGcode += line + "\n";
            }
            
            // Add command to start spindle
            outputGcode += "M03 S5000.0\n";

            for (let depth of increments) {
                for (let line of inputGcode) {
                    if (line.includes("G01") && line.includes("Z")) {
                        outputGcode += "G01 F200 Z" + depth.toFixed(3) + "\n";
                    } else if (line.startsWith("G00") || line.startsWith("G01")) {
                        outputGcode += line + "\n";
                    }
                }
            }

            // Add M05 and M30 after the last pass
            outputGcode += "M05\nM30\n";
            

            // Prepare and present download link
            const blob = new Blob([outputGcode], { type: "text/plain" });
            const downloadUrl = URL.createObjectURL(blob);
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = downloadUrl;
            downloadLink.download = "processed_gcode.nc";
            downloadLink.style.display = "block";
        }
    </script>
</body>

</html>
